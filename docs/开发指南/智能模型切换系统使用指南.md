# æ™ºèƒ½æ¨¡å‹åˆ‡æ¢ç³»ç»Ÿä½¿ç”¨æŒ‡å— ğŸš€

## æ¦‚è¿°

VideoGeniusæ™ºèƒ½æ¨¡å‹åˆ‡æ¢ç³»ç»Ÿæ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„AIæœåŠ¡æ¶æ„ï¼Œé€šè¿‡å¥åº·æ£€æŸ¥ã€æ™ºèƒ½è·¯ç”±ã€æ•…éšœè½¬ç§»å’Œè´Ÿè½½å‡è¡¡ç­‰æŠ€æœ¯ï¼Œç¡®ä¿AIæœåŠ¡çš„ç¨³å®šæ€§å’Œé«˜æ€§èƒ½ã€‚ç³»ç»Ÿæ”¯æŒ9ç§ä¸»æµAIæ¨¡å‹ï¼Œèƒ½å¤Ÿè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ¨¡å‹å¹¶åœ¨æ•…éšœæ—¶æ— ç¼åˆ‡æ¢ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ” å¥åº·æ£€æŸ¥ (Health Check)
- **å®æ—¶ç›‘æ§**ï¼šæ¯5åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰é…ç½®æ¨¡å‹çš„å¥åº·çŠ¶æ€
- **æ€§èƒ½æŒ‡æ ‡**ï¼šç›‘æ§å“åº”æ—¶é—´ã€æˆåŠŸç‡ã€è¿ç»­å¤±è´¥æ¬¡æ•°ç­‰å…³é”®æŒ‡æ ‡
- **çŠ¶æ€åˆ†ç±»**ï¼šå¥åº·(Healthy)ã€é™çº§(Degraded)ã€ä¸å¥åº·(Unhealthy)ã€æœªçŸ¥(Unknown)
- **æˆæœ¬ä¼°ç®—**ï¼šå®æ—¶è®¡ç®—æ¯ä¸ªæ¨¡å‹çš„ä½¿ç”¨æˆæœ¬

### ğŸ§  æ™ºèƒ½è·¯ç”± (Intelligent Router)
- **ç»¼åˆè¯„åˆ†ç®—æ³•**ï¼š
  - åŸºç¡€æƒé‡ (30%)ï¼šæ¨¡å‹çš„åŸºç¡€ä¼˜å…ˆçº§
  - å¥åº·çŠ¶æ€ (25%)ï¼šå½“å‰æ¨¡å‹çš„å¥åº·ç¨‹åº¦
  - æ€§èƒ½æŒ‡æ ‡ (20%)ï¼šå“åº”æ—¶é—´å’Œå¤„ç†é€Ÿåº¦
  - å¯é æ€§ (15%)ï¼šæˆåŠŸç‡å’Œç¨³å®šæ€§
  - æˆæœ¬å› ç´  (10%)ï¼šä½¿ç”¨æˆæœ¬è€ƒé‡
- **åŠ¨æ€æƒé‡è°ƒæ•´**ï¼šæ”¯æŒè¿è¡Œæ—¶è°ƒæ•´æ¨¡å‹æƒé‡
- **å¤‡ç”¨é“¾æœºåˆ¶**ï¼šé¢„è®¾çš„æ•…éšœè½¬ç§»é¡ºåº

### ğŸ”„ æ•…éšœè½¬ç§» (Failover)
- **è‡ªåŠ¨æ£€æµ‹**ï¼šå®æ—¶æ£€æµ‹æ¨¡å‹æ•…éšœå’Œå¼‚å¸¸
- **å¿«é€Ÿåˆ‡æ¢**ï¼š1ç§’å†…å®Œæˆæ•…éšœæ¨¡å‹åˆ‡æ¢
- **å¤šé‡é‡è¯•**ï¼šæœ€å¤š3æ¬¡é‡è¯•ï¼Œæ¯æ¬¡é€‰æ‹©ä¸åŒçš„æœ€ä½³æ¨¡å‹
- **è‡ªåŠ¨æ¢å¤**ï¼šæ£€æµ‹åˆ°æ¨¡å‹æ¢å¤åè‡ªåŠ¨é‡æ–°å¯ç”¨

### âš–ï¸ è´Ÿè½½å‡è¡¡ (Load Balancing)
æ”¯æŒ6ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š

1. **è½®è¯¢ (Round Robin)**ï¼šç®€å•çš„å¾ªç¯é€‰æ‹©
2. **åŠ æƒè½®è¯¢ (Weighted Round Robin)**ï¼šåŸºäºæƒé‡çš„éšæœºé€‰æ‹©
3. **æœ€å°‘è¿æ¥ (Least Connections)**ï¼šé€‰æ‹©å½“å‰æ´»è·ƒè¯·æ±‚æœ€å°‘çš„æ¨¡å‹
4. **å“åº”æ—¶é—´ä¼˜å…ˆ (Response Time)**ï¼šé€‰æ‹©å“åº”æœ€å¿«çš„æ¨¡å‹
5. **éšæœº (Random)**ï¼šéšæœºé€‰æ‹©å¥åº·æ¨¡å‹
6. **æ™ºèƒ½é€‰æ‹© (Intelligent)**ï¼šåŸºäºç»¼åˆè¯„åˆ†çš„æœ€ä¼˜é€‰æ‹©

## æ”¯æŒçš„AIæ¨¡å‹

| æ¨¡å‹åç§° | æä¾›å•† | å›½å†…è®¿é—® | å…è´¹é¢åº¦ | æ¨èæŒ‡æ•° |
|---------|--------|----------|----------|----------|
| DeepSeek | DeepSeek | âœ… | âœ… | â­â­â­â­â­ |
| Claude | Anthropic | âŒ | âŒ | â­â­â­â­ |
| Ernie | ç™¾åº¦ | âœ… | âœ… | â­â­â­â­ |
| Moonshot | æœˆä¹‹æš—é¢ | âœ… | âœ… | â­â­â­â­ |
| OpenAI | OpenAI | âŒ | âŒ | â­â­â­ |
| Ollama | æœ¬åœ° | âœ… | âœ… | â­â­â­ |
| Azure | Microsoft | âŒ | âŒ | â­â­â­ |
| Gemini | Google | âŒ | âœ… | â­â­â­ |
| Qwen | é˜¿é‡Œäº‘ | âœ… | âœ… | â­â­â­ |

## å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€ä½¿ç”¨

```python
from app.services.llm_enhanced import EnhancedLLMService

# åˆ›å»ºæœåŠ¡å®ä¾‹
service = EnhancedLLMService()

# é…ç½®æœåŠ¡
service.configure(
    intelligent_routing=True,      # å¯ç”¨æ™ºèƒ½è·¯ç”±
    load_balancing=True,          # å¯ç”¨è´Ÿè½½å‡è¡¡
    failover=True,                # å¯ç”¨æ•…éšœè½¬ç§»
    load_balance_strategy=LoadBalanceStrategy.INTELLIGENT
)

# ç”Ÿæˆè§†é¢‘è„šæœ¬
script = await service.generate_script_async(
    video_subject="äººå·¥æ™ºèƒ½çš„å‘å±•",
    language="zh-CN",
    paragraph_number=2
)

# ç”Ÿæˆå…³é”®è¯
terms = await service.generate_terms_async(
    video_subject="äººå·¥æ™ºèƒ½",
    video_script=script,
    amount=5
)
```

### 2. åŒæ­¥æ¥å£ä½¿ç”¨

```python
# å…¼å®¹åŸæœ‰APIçš„åŒæ­¥æ¥å£
script = service.generate_script("äººå·¥æ™ºèƒ½çš„å‘å±•", language="zh-CN")
terms = service.generate_terms("äººå·¥æ™ºèƒ½", script, 5)
```

### 3. é…ç½®ç®¡ç†

```python
# åŠ¨æ€è°ƒæ•´æ¨¡å‹æƒé‡
service.router.update_model_weights({
    "deepseek": 1.2,  # æé«˜DeepSeekæƒé‡
    "claude": 0.8     # é™ä½Claudeæƒé‡
})

# è®¾ç½®å¤‡ç”¨é“¾
service.router.set_fallback_chain([
    "deepseek", "ernie", "claude", "openai"
])

# å¼ºåˆ¶å¥åº·æ£€æŸ¥
service.force_health_check("deepseek")  # æ£€æŸ¥å•ä¸ªæ¨¡å‹
service.force_health_check()            # æ£€æŸ¥æ‰€æœ‰æ¨¡å‹
```

## ç›‘æ§å’Œç»Ÿè®¡

### 1. æœåŠ¡ç»Ÿè®¡

```python
stats = service.get_service_stats()
print(f"æ€»è¯·æ±‚æ•°: {stats['total_requests']}")
print(f"æˆåŠŸç‡: {stats['success_rate']:.2%}")
print(f"å¹³å‡å“åº”æ—¶é—´: {stats['avg_response_time']:.2f}s")
print(f"è¿è¡Œæ—¶é—´: {stats['uptime_formatted']}")
```

### 2. æ¨¡å‹å¥åº·çŠ¶æ€

```python
health = service.get_model_health_status()
for model, metrics in health.items():
    print(f"{model}: {metrics.status.value}")
    print(f"  å“åº”æ—¶é—´: {metrics.response_time:.2f}s")
    print(f"  æˆåŠŸç‡: {metrics.success_rate:.2%}")
```

### 3. è´Ÿè½½å‡è¡¡ç»Ÿè®¡

```python
load_stats = service.get_load_balancer_stats()
for model, stats in load_stats.items():
    print(f"{model}:")
    print(f"  æ€»è¯·æ±‚: {stats['total_requests']}")
    print(f"  æ´»è·ƒè¯·æ±‚: {stats['active_requests']}")
    print(f"  å¹³å‡å“åº”æ—¶é—´: {stats['avg_response_time']}s")
```

## é…ç½®æ–‡ä»¶è®¾ç½®

åœ¨ `config.toml` ä¸­æ·»åŠ æ¨¡å‹æƒé‡é…ç½®ï¼š

```toml
[app.model_weights]
deepseek = 1.0
claude = 0.9
ernie = 0.95
moonshot = 0.85
openai = 0.8
ollama = 0.7
azure = 0.8
gemini = 0.75
qwen = 0.85
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ¨¡å‹é€‰æ‹©ç­–ç•¥
- **å›½å†…ç”¨æˆ·**ï¼šä¼˜å…ˆä½¿ç”¨ DeepSeekã€Ernieã€Moonshot
- **æµ·å¤–ç”¨æˆ·**ï¼šä¼˜å…ˆä½¿ç”¨ Claudeã€OpenAIã€Gemini
- **æœ¬åœ°éƒ¨ç½²**ï¼šè€ƒè™‘ä½¿ç”¨ Ollama

### 2. è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©
- **é«˜å¹¶å‘åœºæ™¯**ï¼šä½¿ç”¨ `LEAST_CONNECTIONS` æˆ– `INTELLIGENT`
- **ç¨³å®šæ€§ä¼˜å…ˆ**ï¼šä½¿ç”¨ `RESPONSE_TIME` æˆ– `WEIGHTED_ROUND_ROBIN`
- **ç®€å•åœºæ™¯**ï¼šä½¿ç”¨ `ROUND_ROBIN`

### 3. å¥åº·æ£€æŸ¥ä¼˜åŒ–
- è°ƒæ•´æ£€æŸ¥é—´éš”ï¼šé»˜è®¤5åˆ†é’Ÿï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼šé¿å…é•¿æ—¶é—´ç­‰å¾…
- ç›‘æ§å…³é”®æŒ‡æ ‡ï¼šé‡ç‚¹å…³æ³¨æˆåŠŸç‡å’Œå“åº”æ—¶é—´

## æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

**Q: æ‰€æœ‰æ¨¡å‹éƒ½æ˜¾ç¤ºä¸å¥åº·æ€ä¹ˆåŠï¼Ÿ**
A: æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPI Keyé…ç½®ï¼Œç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªæ¨¡å‹é…ç½®æ­£ç¡®ã€‚

**Q: å“åº”æ—¶é—´å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ**
A: æ£€æŸ¥ç½‘ç»œçŠ¶å†µï¼Œè€ƒè™‘ä½¿ç”¨å›½å†…æ¨¡å‹æˆ–è°ƒæ•´è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚

**Q: æ•…éšœè½¬ç§»ä¸ç”Ÿæ•ˆæ€ä¹ˆåŠï¼Ÿ**
A: ç¡®è®¤ `failover=True` ä¸”è‡³å°‘é…ç½®äº†2ä¸ªä»¥ä¸Šçš„æ¨¡å‹ã€‚

### 2. è°ƒè¯•æ¨¡å¼

```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
import logging
logging.getLogger().setLevel(logging.DEBUG)

# æŸ¥çœ‹è¯¦ç»†çš„æ¨¡å‹é€‰æ‹©è¿‡ç¨‹
service.router.select_best_model("script")  # ä¼šè¾“å‡ºè¯¦ç»†çš„è¯„åˆ†è¿‡ç¨‹
```

### 3. é‡ç½®ç»Ÿè®¡

```python
# é‡ç½®æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯
service.reset_stats()
```

## æœ€ä½³å®è·µ

### 1. ç”Ÿäº§ç¯å¢ƒé…ç½®
```python
service.configure(
    intelligent_routing=True,
    load_balancing=True,
    failover=True,
    load_balance_strategy=LoadBalanceStrategy.INTELLIGENT
)
```

### 2. å¼€å‘ç¯å¢ƒé…ç½®
```python
service.configure(
    intelligent_routing=False,  # å…³é—­æ™ºèƒ½è·¯ç”±ï¼Œä½¿ç”¨å›ºå®šæ¨¡å‹
    load_balancing=False,
    failover=False
)
```

### 3. ç›‘æ§å‘Šè­¦
- å®šæœŸæ£€æŸ¥æœåŠ¡ç»Ÿè®¡ä¿¡æ¯
- ç›‘æ§æ¨¡å‹å¥åº·çŠ¶æ€å˜åŒ–
- è®¾ç½®æˆåŠŸç‡é˜ˆå€¼å‘Šè­¦

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EnhancedLLMService                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Health Checker â”‚  â”‚ Intelligent     â”‚  â”‚ Load Balancer   â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚ Router          â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ â€¢ å¥åº·ç›‘æ§      â”‚  â”‚ â€¢ æ™ºèƒ½é€‰æ‹©      â”‚  â”‚ â€¢ è´Ÿè½½åˆ†é…      â”‚ â”‚
â”‚  â”‚ â€¢ æ€§èƒ½ç»Ÿè®¡      â”‚  â”‚ â€¢ è¯„åˆ†ç®—æ³•      â”‚  â”‚ â€¢ ç­–ç•¥ç®¡ç†      â”‚ â”‚
â”‚  â”‚ â€¢ çŠ¶æ€ç®¡ç†      â”‚  â”‚ â€¢ æƒé‡è°ƒæ•´      â”‚  â”‚ â€¢ å¹¶å‘æ§åˆ¶      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Failover Manager                         â”‚
â”‚  â€¢ æ•…éšœæ£€æµ‹  â€¢ è‡ªåŠ¨åˆ‡æ¢  â€¢ é‡è¯•æœºåˆ¶  â€¢ æ¢å¤æ£€æµ‹            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      AI Models                              â”‚
â”‚  DeepSeek â”‚ Claude â”‚ Ernie â”‚ Moonshot â”‚ OpenAI â”‚ Ollama...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-05-28)
- âœ… æ–°å¢æ™ºèƒ½æ¨¡å‹åˆ‡æ¢ç³»ç»Ÿ
- âœ… æ”¯æŒ9ç§AIæ¨¡å‹çš„å¥åº·æ£€æŸ¥
- âœ… å®ç°æ™ºèƒ½è·¯ç”±å’Œæ•…éšœè½¬ç§»
- âœ… æ·»åŠ 6ç§è´Ÿè½½å‡è¡¡ç­–ç•¥
- âœ… å®Œå–„æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
- âœ… æä¾›å®Œæ•´çš„APIå…¼å®¹æ€§

---

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚ 